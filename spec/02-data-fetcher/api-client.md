# 楽天市場商品ランキングAPI通信仕様

## 1. 概要

本ドキュメントは、楽天市場商品ランキングAPIと通信するためのクライアントモジュールの基本設計を定義します。このクライアントモジュールは、楽天市場の商品ランキングデータを効率的に取得し、必要なデータ形式に変換する役割を担います。

## 2. API基本情報

「楽天市場商品ランキングAPI」を使用することで、様々な条件で楽天市場の商品ランキングを取得できます。

### 2.1 エンドポイント

```
https://app.rakuten.co.jp/services/api/IchibaItem/Ranking/20170628
```

### 2.2 認証方法

- **アプリケーションID**: applicationIdパラメータを使用（必須）
- **アフィリエイトID**: affiliateIdパラメータを使用（オプション）

### 2.3 主要リクエストパラメータ

| パラメータ名 | 説明 | 値の例 | 必須 |
|------------|------|-------|------|
| applicationId | 楽天アプリケーションID | "1234567890abcdef1234567890abcdef" | ○ |
| affiliateId | 楽天アフィリエイトID | "abcdef12-1234-1234-1234-1234567890ab" | × |
| genreId | 取得するジャンルID | "100371"（レディースファッション） | × |
| age | 年齢層 | 0:指定なし, 10:10代, 20:20代, 30:30代, 40:40代, 50:50~代 | × |
| sex | 性別 | 0:指定なし, 1:男性, 2:女性 | × |
| carrier | キャリア | 0:PC, 1:携帯, 2:スマートフォン | × |
| page | ページ番号 | 1, 2, 3, ... | × |
| hits | 1ページあたりの取得件数 | 1~30（デフォルト:30） | × |
| period | 集計期間 | 日次:1, 週次:7, 月次:30 | × |
| tagId | タグID | 1000323:送料無料, 1000320:ポイント○倍, 1000397:あす楽 | × |
| NGKeyword | 除外キーワード | NGを設定したいキーワードを指定 | × |
| minPrice | 最低価格 | 数値(例:1000) | × |
| maxPrice | 最高価格 | 数値(例:10000) | × |
| field | 取得フィールド | おすすめ:0, 最新:1, 売上:2, 人気:3, 支持:4, 注目:5 | × |
| format | レスポンス形式 | "json" または "xml"（デフォルト:json） | × |

※ genreId については[楽天市場ジャンル一覧API](https://webservice.rakuten.co.jp/api/ichibagenre/)で取得可能

### 2.4 リクエスト例

```
https://app.rakuten.co.jp/services/api/IchibaItem/Ranking/20170628?applicationId=1234567890abcdef1234567890abcdef&genreId=100371&sex=2&page=1&hits=30&format=json
```

### 2.5 レスポンス構造

#### 成功時の主要レスポンス構造（JSON）

レスポンスは以下の主要項目を含むJSON形式で返却されます：

- **Items**: 商品情報の配列（各要素は「Item」オブジェクトを含む）
  - itemCode: 商品コード
  - itemName: 商品名
  - itemPrice: 価格
  - itemUrl: 商品URL
  - shopName: ショップ名
  - shopUrl: ショップURL
  - genreId: ジャンルID
  - mediumImageUrls: 画像URL配列
  - pointRate: ポイント還元率
  - reviewCount: レビュー件数
  - reviewAverage: レビュー平均点
  - rank: ランキング順位
  - その他の商品属性（送料情報、在庫状況など）

- **GenreInformation**: ジャンル情報（親・現在・子ジャンル）
- **TagInformation**: タグ情報（ID・名称・商品数）
- **pageCount**: 総ページ数
- **hits**: 取得件数
- **count**: 総商品数
- **page**: 現在のページ番号
- その他のメタデータ

#### エラー時のレスポンス例

```json
{
  "error": "wrong_parameter",
  "error_description": "不正なパラメータが指定されています。"
}
```

## 3. クライアント設計

### 3.1 基本インターフェース設計

クライアントモジュールは以下の主要インターフェースを提供します：

1. **単一ページ取得**: 指定条件に基づく商品ランキングの単一ページを取得
2. **複数ページ取得**: 最大件数を指定して複数ページを一括取得

クライアントは以下のデータ型を定義します：

- **FetchOptions**: 単一リクエストのパラメータを定義
- **FetchAllOptions**: 複数ページ取得用のパラメータを定義
- **RakutenItemResponse**: APIレスポンスの型定義
- **RakutenItem**: 商品情報の型定義
- **GenreInformationType**: ジャンル情報の型定義
- **TagInformationType**: タグ情報の型定義

### 3.2 クライアント実装の基本方針

クライアントの実装では以下の機能を提供します：

1. **認証情報管理**: アプリケーションIDとアフィリエイトIDの管理
2. **パラメータ構築**: リクエストURLのパラメータ適切な構築
3. **レスポンス処理**: JSON応答の適切な解析と型変換
4. **エラー処理**: 様々なエラー状況への対応
5. **ページング処理**: 複数ページの効率的な取得
6. **レート制限対応**: APIの利用制限に対する適切な対応

## 4. 主要ユースケース

クライアントモジュールでは以下の主要なユースケースをサポートします：

1. **ジャンル指定ランキング取得**: 特定ジャンルの人気商品を取得
2. **条件フィルタリング**: 性別、年齢、価格帯などでフィルタリング
3. **タグによる絞り込み**: 送料無料やポイント倍率などのタグで絞り込み
4. **複数ページの一括取得**: 最大件数を指定して複数ページを効率的に取得

## 5. エラーハンドリング戦略

APIクライアントは以下のエラー状況に対応します：

1. **ネットワークエラー**: 接続エラーや通信タイムアウト
2. **APIエラー**: 不正なパラメータやレート制限の超過など
3. **データエラー**: 想定外のレスポンス形式など
4. **認証エラー**: 無効なAPIキーによるエラー

カスタムエラークラスを定義し、各エラータイプに対して適切な情報を提供します。エラータイプは以下のカテゴリに分類します：

- NETWORK_ERROR: ネットワーク関連のエラー
- RATE_LIMIT_ERROR: APIレート制限に関するエラー
- PARAMETER_ERROR: リクエストパラメータに関するエラー
- DATA_ERROR: レスポンスデータに関するエラー
- UNKNOWN_ERROR: その他の未分類エラー

## 6. パフォーマンス最適化方針

APIクライアントは以下のパフォーマンス最適化を実装します：

1. **並列リクエスト**: 複数ページの同時取得による高速化
2. **リトライ機構**: 一時的なエラーに対する再試行処理
3. **キャッシュ機構**: 頻繁なリクエストの結果をキャッシュ
4. **バッチサイズ最適化**: 最適なhitsパラメータ設定

## 7. レート制限対応方針

楽天市場APIには以下のレート制限があります：

- 1分あたり最大100リクエスト
- アプリケーションIDごとに計測

以下の戦略でレート制限に対応します：

1. **リクエスト間隔の調整**: 適切な間隔を空ける
2. **リクエスト数のカウント**: 現在のリクエスト数を追跡
3. **レート制限エラーの検出**: 429ステータスコードの適切な処理
4. **バックオフ戦略**: エラー時は指数バックオフでリトライ

レート制限管理クラスを実装し、リクエスト履歴の追跡と待機時間の計算を行います。

## 8. 主要ジャンルIDリファレンス

楽天市場の主要ジャンルIDを以下に示します。完全なジャンル情報は[楽天市場ジャンル一覧API](https://webservice.rakuten.co.jp/documentation/ichiba-genre-search)で取得できます。

| ジャンルID | ジャンル名 |
|------------|------------|
| 0 | すべてのジャンル |
| 100371 | レディースファッション |
| 551177 | メンズファッション |
| 100433 | インナー・下着・ナイトウェア |
| 216129 | バッグ・小物・ブランド雑貨 |
| 558885 | 靴・シューズ |
| 558929 | 腕時計 |
| 216131 | ジュエリー・アクセサリー |
| 100533 | キッズ・ベビー・マタニティ |
| 566382 | 食品 |
| 100227 | スイーツ・お菓子 |
| 100316 | 水・ソフトドリンク |
| 510915 | ビール・洋酒 |
| 510901 | 日本酒・焼酎 |
| 100804 | インテリア・家具・収納 |
| 215783 | 日用品雑貨・文房具・手芸 |
| 558944 | キッチン用品・食器・調理器具 |
| 200162 | 花・ガーデン・DIY |
| 101070 | ペット・ペットグッズ |
| 101213 | ダイエット・健康 |
| 100939 | 医薬品・コンタクト・介護 |
| 100938 | 美容・コスメ・香水 |
| 101114 | スポーツ・アウトドア |
| 101205 | ゴルフ用品 |
| 101164 | 自転車・サイクリング |
| 216129 | 釣り・フィッシング |
| 101438 | おもちゃ・ホビー・ゲーム |
| 101354 | CD・DVD・楽器 |
| 100026 | パソコン・周辺機器 |
| 564500 | スマートフォン・タブレット |
| 211742 | 家電 |
| 101240 | TV・オーディオ・カメラ |
| 101381 | 車・バイク |
| 101986 | サービス・リフォーム |
| 102225 | 住宅・不動産 |

## 9. 主要タグIDリファレンス

楽天市場の主要タグIDとその意味を以下に示します。

| タグID | タグ名 |
|--------|--------|
| 1000323 | 送料無料 |
| 1000320 | ポイント○倍 |
| 1000397 | あす楽 |
| 1000883 | 送料別 |
| 1000901 | 即日配送 |
| 1000878 | 在庫あり |
| 1000887 | お買い得 |
| 1000888 | おすすめ |
| 1000904 | 新商品 |
| 1000371 | タイムセール |
| 1000376 | 予約商品 |
| 1000379 | 限定品 |
| 1000380 | 福袋 |

## 10. まとめ

本設計書では、楽天市場商品ランキングAPIを利用するためのクライアントモジュールの基本設計を定義しました。APIの基本情報、リクエスト・レスポンス構造、クライアント設計の基本方針、ユースケース、エラーハンドリング戦略、パフォーマンス最適化、レート制限対応方針について説明しています。

この設計に基づいて実装することで、楽天市場の商品ランキングを効率的に取得し、様々な条件でのフィルタリングが可能なAPIクライアントを構築できます。なお、実際の実装にあたっては、楽天ウェブサービスの最新のAPIドキュメントを参照し、変更があれば適宜対応することを推奨します。