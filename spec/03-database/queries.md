# クエリ設計仕様書

## 1. 基本方針
### パフォーマンス最適化
- インデックスの効果的な活用
- 不要なJOINの回避
- 適切なWHERE句の設定

### データ整合性の確保
- トランザクション管理
- ACID特性の遵守
- デッドロック対策

## 2. 主要クエリパターン

### 日次ランキングデータの保存
1. daily_rankingsテーブルへの挿入
   - 重複チェック（fetch_date）
   - 一意制約違反の適切なハンドリング

2. itemsテーブルへの一括挿入
   - バッチ処理の最適化
   - エラーハンドリング

### 商品情報の取得
1. 最新ランキングの取得
   - fetch_dateによる絞り込み
   - ランキング順でのソート

2. 期間指定での商品情報取得
   - 日付範囲指定
   - ランキング変動の分析

### 投稿用商品の抽出
1. ランダム抽出ロジック
   - 重複投稿の防止
   - 評価条件による絞り込み

2. 投稿履歴との突合
   - 既投稿商品の除外
   - 時間間隔の考慮

## 3. クエリ最適化戦略

### インデックス活用
- WHERE句での検索条件
- JOIN条件
- ORDER BY句

### パーティショニング戦略
- 日付ベースのパーティショニング
- アクセスパターンの最適化

### 集計クエリの最適化
- マテリアライズドビューの活用
- 事前集計の検討

## 4. エラーハンドリング

### 一意制約違反
- UPSERT（ON CONFLICT）の活用
- エラーメッセージの標準化

### 外部キー制約違反
- 参照整合性チェック
- カスケード操作の制御

### タイムアウト対策
- クエリタイムアウトの設定
- 長時間クエリの検出と対策

## 5. 監視と最適化

### パフォーマンスモニタリング
- スロークエリの検出
- 実行計画の分析

### キャッシュ戦略
- キャッシュヒット率の最適化
- キャッシュ無効化の制御

### コネクション管理
- コネクションプールの設定
- デッドロック検出と解決